# Actime 需求决策文档

## 项目目标
开发一个跨平台（Windows + Linux）的后台进程，用于准确统计用户在前台软件上的真实活跃时间，而非系统运行时。

## 核心需求

### 功能需求

#### 1. 前台应用检测
- 实时检测当前活动的应用程序（进程名）
- 获取窗口标题（可选）
- 支持窗口切换检测

#### 2. 活跃状态监控
- 监控用户输入活动（键盘和鼠标）
- 使用5分钟活动窗口作为活跃判定标准
- 空闲时间超过5分钟则停止计时

#### 3. 数据记录
- 记录每个应用的累计活跃时长
- 记录会话的开始和结束时间
- 支持按日统计

#### 4. 数据存储
- 使用本地SQLite数据库存储
- 支持数据持久化
- 支持数据查询和导出

#### 5. 数据导出
- 支持CSV格式导出
- 支持JSON格式导出
- 支持按日期范围导出

#### 6. 后台运行
- 支持作为系统服务运行
- 支持自启动
- 支持优雅关闭

#### 7. 可选功能
- Prometheus指标暴露（可选）
- 高级统计分析（可选）

### 非功能需求

#### 1. 性能要求
- 内存占用: < 20MB（运行时）
- CPU占用: < 1%（空闲时）
- 启动时间: < 1秒
- 检测间隔: 1秒
- 数据持久化间隔: 60秒

#### 2. 可靠性要求
- 崩溃恢复机制
- 异常处理和日志记录
- 数据一致性保证
- 休眠/唤醒状态正确处理

#### 3. 兼容性要求
- 支持Linux（X11环境）
- 支持Windows 7+
- 支持主流桌面环境

#### 4. 安全性要求
- 最小权限原则
- 不记录用户输入内容
- 数据本地存储，不上传

## 活跃状态检测决策

### 活跃定义
**决策**: 任何键盘或鼠标输入都算作活跃，使用空闲时间作为判断依据。

### 活跃窗口逻辑
**决策**: 按窗口切换分段记录，切换时切换活跃目标。

**示例**:
```
用户操作流程:
1. 打开Chrome，使用3分钟 → Chrome: 3分钟
2. 切换到VS Code，使用2分钟 → VS Code: 2分钟
3. 切回Chrome，继续使用 → Chrome: 继续累计
```

### 输入事件检测方式
**决策**: 使用查询空闲时间方式，而非监听所有输入事件。

**理由**:
- 性能开销小（每秒1次查询 vs 每秒数百个事件）
- 权限要求低（无需全局钩子）
- 准确性足够（5分钟容错）

**实现方式**:
- Linux: XScreenSaverInfo.idle
- Windows: GetLastInputInfo()

### 休眠/唤醒处理
**决策**: 休眠期间不计入任何应用的使用时间。

### 屏幕锁定处理
**决策**: 屏幕锁定后停止所有计时。

### 记录粒度
**决策**: 秒级检测，分钟级持久化。

**理由**:
- 秒级检测保证准确性
- 分钟级持久化减少IO开销

## 技术选型决策

### 开发语言
**决策**: Go语言

**理由**:
- 跨平台支持好
- 性能优异
- 标准库丰富
- 编译产物单一二进制文件
- 适合新手学习

### GUI需求
**决策**: 不需要GUI，纯后台进程

### 数据库
**决策**: SQLite

**理由**:
- 轻量级，无需服务器
- 适合本地应用
- 跨平台支持好
- Go生态支持完善

**具体选择**: `modernc.org/sqlite`（纯Go实现，无需CGO）

### 系统监控库
**Linux**: 
- `github.com/BurntSushi/xgb` - X11协议绑定
- `github.com/BurntSushi/xgbutil` - X11工具库

**Windows**:
- `golang.org/x/sys/windows` - Windows系统调用

### 日志系统
**决策**: Go标准库 `log/slog`

**理由**:
- 标准库，零依赖
- 结构化日志支持
- 性能好

### 配置管理
**决策**: YAML格式 + `gopkg.in/yaml.v3`

**理由**:
- YAML易读易写
- 轻量级库
- 支持复杂配置结构

### 命令行工具
**决策**: Go标准库 `flag`

**理由**:
- 标准库，零依赖
- 满足基本需求
- 性能好

### 进程管理
**决策**: `github.com/kardianos/service`

**理由**:
- 跨平台服务封装
- 轻量级
- 成熟稳定

## 数据模型决策

### 会话记录（sessions）
```go
type Session struct {
    ID              int64
    AppName         string      // 应用名称
    WindowTitle     string      // 窗口标题（可选）
    StartTime       time.Time   // 开始时间
    EndTime         time.Time   // 结束时间
    DurationSeconds int64       // 持续时长（秒）
    CreatedAt       time.Time   // 创建时间
}
```

### 每日统计（daily_stats）
```go
type DailyStats struct {
    ID           int64
    AppName      string    // 应用名称
    Date         time.Time // 日期
    TotalSeconds int64     // 总时长（秒）
}
```

## 不实现的功能

以下功能明确不实现：

1. **输入内容记录** - 不记录用户输入的具体内容
2. **屏幕截图** - 不进行屏幕截图
3. **网络监控** - 不监控网络活动
4. **远程数据上传** - 所有数据仅本地存储
5. **实时GUI界面** - 不提供实时监控界面
6. **高级统计图表** - 仅提供基础统计和导出

## 优先级划分

### P0 - 核心功能（必须实现）
1. 前台窗口检测
2. 空闲时间检测
3. 活跃时间记录
4. 数据存储
5. 服务管理

### P1 - 重要功能（优先实现）
1. 数据导出（CSV/JSON）
2. 基础统计查询
3. 日志系统
4. 配置管理

### P2 - 可选功能（后续实现）
1. Prometheus指标
2. 高级统计分析
3. 数据可视化

## 用户场景

### 场景1: 日常使用
用户正常使用电脑，系统后台自动记录各应用使用时长。

### 场景2: 休眠唤醒
用户休眠电脑，唤醒后继续使用，系统能正确处理休眠期间的时间。

### 场景3: 窗口切换
用户频繁切换窗口，系统能准确记录每个窗口的使用时长。

### 场景4: 长时间空闲
用户离开电脑超过5分钟，系统自动停止计时。

### 场景5: 数据导出
用户需要查看某段时间的应用使用统计，导出为CSV或JSON格式。

## 约束条件

1. **开发环境**: Go 1.21+
2. **运行环境**: Linux（X11）或 Windows 7+
3. **权限要求**: 普通用户权限（Windows某些功能可能需要管理员）
4. **磁盘空间**: 数据库文件大小取决于使用时长，预计每月 < 10MB
5. **网络要求**: 无需网络连接

## 验收标准

### 功能验收
- [ ] 能准确检测前台窗口
- [ ] 能正确判断用户活跃状态
- [ ] 能准确记录应用使用时长
- [ ] 数据能正确存储到数据库
- [ ] 能正常启动和停止服务
- [ ] 能导出数据为CSV/JSON

### 性能验收
- [ ] 内存占用 < 20MB
- [ ] CPU占用 < 1%（空闲时）
- [ ] 启动时间 < 1秒
- [ ] 数据持久化不影响性能

### 稳定性验收
- [ ] 能正确处理休眠/唤醒
- [ ] 能正确处理窗口切换
- [ ] 能正确处理异常情况（崩溃等）
- [ ] 数据一致性保证

## 未来扩展方向

1. **Wayland支持** - 支持Linux Wayland显示服务器
2. **macOS支持** - 扩展到macOS平台
3. **Web界面** - 提供Web界面查看统计
4. **云同步** - 支持数据云端同步（可选）
5. **插件系统** - 支持自定义统计规则